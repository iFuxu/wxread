name: WeRead Auto

on:
  schedule:
    - cron: '0 22 * * *'    # åŒ—äº¬æ—¶é—´22:00
    - cron: '0 5 * * *'     # åŒ—äº¬æ—¶é—´5:00
    - cron: '40 11 * * *'   # åŒ—äº¬æ—¶é—´11:40
    - cron: '0 17 * * 6,7'  # å‘¨æœ«17:00ï¼ˆå‘¨å…­/æ—¥ï¼‰
    - cron: '0 8 * * 1'     # å‘¨ä¸€8:00
  timezone: Asia/Shanghai  # âœ… ä¿®æ­£ä½ç½®ï¼šç§»è‡³scheduleåˆ—è¡¨åŒçº§

  workflow_dispatch:
    inputs:
      mode:
        description: 'è¿è¡Œæ¨¡å¼ (auto/manual)'
        required: false
        default: 'auto'

jobs:
  generate-reading-time:
    runs-on: ubuntu-22.04
    environment: Production

    steps:
    - name: ðŸ› ï¸ æ£€å‡ºä»£ç 
      uses: actions/checkout@v4

    - name: ðŸ é…ç½®PythonçŽ¯å¢ƒ
      uses: actions/setup-python@v5
      with:
        python-version: '3.10'

    - name: ðŸ“¦ å®‰è£…ä¾èµ–
      run: pip install requests==2.32.3

    - name: â³ éšæœºå»¶è¿Ÿ
      if: github.event_name == 'schedule' && github.event.inputs.mode != 'manual'
      run: |
        if [ $(date +%u) -eq 1 ] && [ $(date +%H) -eq 8 ]; then
          echo "â© è·³è¿‡å‘¨ä¸€ä»»åŠ¡å»¶è¿Ÿ"
          exit 0
        fi
        DELAY=$((RANDOM % 21))
        echo "éšæœºå»¶è¿Ÿ ${DELAY} åˆ†é’Ÿ"
        sleep ${DELAY}m

    - name: ðŸŽ² å‘¨éšæœºè·³è¿‡
      if: github.event_name == 'schedule' && github.event.inputs.mode == 'auto'
      run: |
        if [ $(date +%u) -eq 1 ] && [ $(date +%H) -eq 8 ]; then
          if [ $((RANDOM % 7)) -eq 0 ]; then
            echo "â© æœ¬å‘¨ä»»åŠ¡å·²è·³è¿‡"
            exit 0
          fi
        fi

    - name: ðŸ•’ ç”Ÿæˆé˜…è¯»æ—¶é•¿
      id: time-generator
      run: |
        MODE="${{ github.event.inputs.mode }}"
        if [[ "$MODE" == "manual" ]]; then
          NUM=$((90 + RANDOM % 91))
          echo "æ‰‹åŠ¨ç”Ÿæˆæ—¶é•¿: ${NUM}ç§’"
        else
          CURRENT_HOUR=$(date +%-H)
          CURRENT_WEEKDAY=$(date +%u)

          case "${CURRENT_HOUR}" in
            5)   # æ™¨é—´ä»»åŠ¡
              NUM=$((90 + RANDOM % 61)) ;;
            11)  # åˆé—´ä»»åŠ¡
              NUM=$((120 + RANDOM % 61)) ;;
            22)  # æ™šé—´ä»»åŠ¡
              NUM=$((120 + RANDOM % 61)) ;;
            17)  # å‘¨æœ«ä»»åŠ¡
              if [ $CURRENT_WEEKDAY -ge 6 ]; then
                NUM=$((120 + RANDOM % 61))
              else
                echo "âš ï¸ éžå‘¨æœ«æ—¶é—´è·³è¿‡å‘¨æœ«ä»»åŠ¡"
                NUM=0
              fi ;;
            8)   # å‘¨ä¸€ä»»åŠ¡
              NUM=$((120 + RANDOM % 61)) ;;
            *)
              echo "âŒ æœªåŒ¹é…åˆ°æœ‰æ•ˆæ—¶é—´æ®µ"
              exit 1 ;;
          esac
        fi
        echo "read_time=$NUM" >> $GITHUB_OUTPUT

    - name: ðŸ“¤ ç»“æžœè¾“å‡º
      if: steps.time-generator.outputs.read_time != '0'
      run: |
        echo "âœ… æœ€ç»ˆé˜…è¯»æ—¶é•¿ï¼š${{ steps.time-generator.outputs.read_time }}ç§’"
