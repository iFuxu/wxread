##############################
### å¾®ä¿¡è¯»ä¹¦è‡ªåŠ¨åŒ–é…ç½®
##############################
name: WeRead Automation

on:
  schedule:
    # åŒ—äº¬æ—¶é—´å®šæ—¶ä»»åŠ¡ï¼ˆæ¯ä¸ªä»»åŠ¡ç‹¬ç«‹è®¾ç½®æ—¶åŒºï¼‰
    - cron: '0 22 * * *'     # æ¯å¤©22:00
      timezone: Asia/Shanghai
    - cron: '0 5 * * *'      # æ¯å¤©5:00
      timezone: Asia/Shanghai
    - cron: '40 11 * * *'    # æ¯å¤©11:40
      timezone: Asia/Shanghai
    - cron: '0 17 * * 6,7'   # å‘¨æœ«17:00ï¼ˆå‘¨å…­/æ—¥ï¼‰
      timezone: Asia/Shanghai
    - cron: '0 8 * * 1'      # å‘¨ä¸€8:00
      timezone: Asia/Shanghai

  workflow_dispatch:
    inputs:
      mode:
        description: 'è¿è¡Œæ¨¡å¼é€‰æ‹©'
        required: false
        default: 'auto'
        type: choice
        options:
          - auto
          - manual

jobs:
  time-generator:
    runs-on: ubuntu-22.04
    environment: Production

    steps:
    - name: ðŸ”„ ä»£ç æ£€å‡º
      uses: actions/checkout@v4

    - name: ðŸ PythonçŽ¯å¢ƒ
      uses: actions/setup-python@v5
      with:
        python-version: '3.10'

    - name: ðŸ“¦ ä¾èµ–å®‰è£…
      run: pip install requests==2.32.3

    - name: â³ æ™ºèƒ½å»¶è¿Ÿ
      if: ${{ github.event_name == 'schedule' && inputs.mode != 'manual' }}
      run: |
        # å‘¨ä¸€ä»»åŠ¡ä¸å»¶è¿Ÿ
        if [ $(date +%u) -eq 1 ] && [ $(date +%H) -eq 8 ]; then
          echo "â© è·³è¿‡å‘¨ä¸€å»¶è¿Ÿ"
          exit 0
        fi
        
        # ç”Ÿæˆéšæœºå»¶è¿Ÿï¼ˆ0-20åˆ†é’Ÿï¼‰
        DELAY=$(( RANDOM % 21 ))
        echo "ðŸ•’ å»¶è¿Ÿæ—¶é—´ï¼š${DELAY}åˆ†é’Ÿ"
        sleep ${DELAY}m

    - name: ðŸŽ² å‘¨éšæœºæœºåˆ¶
      if: ${{ github.event_name == 'schedule' && inputs.mode == 'auto' }}
      run: |
        # æ¯å‘¨ä¸€1/7æ¦‚çŽ‡è·³è¿‡
        if [ $(date +%u) -eq 1 ] && [ $(date +%H) -eq 8 ]; then
          if [ $(( RANDOM % 7 )) -eq 0 ]; then
            echo "â© æœ¬å‘¨ä»»åŠ¡å·²è·³è¿‡"
            exit 0
          fi
        fi

    - name: ðŸ•’ æ—¶é•¿ç”Ÿæˆ
      id: generate-time
      run: |
        # æ¨¡å¼åˆ¤æ–­
        if [[ "${{ inputs.mode }}" == "manual" ]]; then
          NUM=$(( 90 + RANDOM % 91 ))  # æ‰‹åŠ¨æ¨¡å¼90-180
          echo "ðŸ› ï¸ æ‰‹åŠ¨ç”Ÿæˆæ—¶é•¿ï¼š${NUM}ç§’"
        else
          # è‡ªåŠ¨æ¨¡å¼æ—¶é—´åˆ¤æ–­
          CURRENT_HOUR=$(date +%-H)
          CURRENT_WEEKDAY=$(date +%u)
          
          case "${CURRENT_HOUR}" in
            5)   # æ™¨é—´ä»»åŠ¡5:00
              NUM=$(( 90 + RANDOM % 61 )) ;;  # 90-150
            11)  # åˆé—´ä»»åŠ¡11:40
              NUM=$(( 120 + RANDOM % 61 )) ;; # 120-180
            22)  # æ™šé—´ä»»åŠ¡22:00
              NUM=$(( 120 + RANDOM % 61 )) ;;
            17)  # å‘¨æœ«ä»»åŠ¡17:00
              if [ $CURRENT_WEEKDAY -ge 6 ]; then
                NUM=$(( 120 + RANDOM % 61 ))
              else
                echo "âš ï¸ éžå‘¨æœ«è·³è¿‡"
                NUM=0
              fi ;;
            8)   # å‘¨ä¸€ä»»åŠ¡8:00
              NUM=$(( 120 + RANDOM % 61 )) ;;
            *)
              echo "âŒ æ—¶é—´åŒ¹é…é”™è¯¯"
              exit 1 ;;
          esac
        fi
        
        # è¾“å‡ºç»“æžœ
        echo "read_time=${NUM}" >> $GITHUB_OUTPUT

    - name: ðŸ“¤ ç»“æžœè¾“å‡º
      if: ${{ steps.generate-time.outputs.read_time != 0 }}
      run: |
        echo "âœ… æœ€ç»ˆé˜…è¯»æ—¶é•¿ï¼š${{ steps.generate-time.outputs.read_time }}ç§’"
