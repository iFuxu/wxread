##############################
### å·¥ä½œæµåŸºæœ¬ä¿¡æ¯é…ç½®
##############################
name: wxread

on:
  ##############################
  ### è§¦å‘æ¡ä»¶é…ç½®ï¼ˆåŒ—äº¬æ—¶é—´ï¼‰
  ##############################
  schedule:
    - cron: '0 22 * * *'        # æ¯å¤©22:00
    - cron: '0 5 * * *'         # æ¯å¤©5:00
    - cron: '40 11 * * *'       # æ¯å¤©11:40
    - cron: '0 17 * * 6,7'      # å‘¨æœ«17:00ï¼ˆå‘¨å…­/æ—¥ï¼‰
    - cron: '0 8 * * 1'         # å‘¨ä¸€8:00
    timezone: Asia/Shanghai     # æ˜¾å¼å£°æ˜æ—¶åŒº

  workflow_dispatch:
    inputs:
      mode:
        description: 'è¿è¡Œæ¨¡å¼ (auto/manual)'
        required: false
        default: 'auto'

jobs:
  deploy:
    runs-on: ubuntu-22.04
    environment: AutoRead

    steps:
    ##############################
    ### ç¯å¢ƒåˆå§‹åŒ–
    ##############################
    - name: ğŸ“¥ æ£€å‡ºä»“åº“
      uses: actions/checkout@v4

    - name: ğŸ è®¾ç½®Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.10'

    - name: ğŸ“¦ å®‰è£…ä¾èµ–
      run: pip install requests==2.32.3

    ##############################
    ### æ™ºèƒ½ä»»åŠ¡è°ƒåº¦
    ##############################
    - name: â±ï¸ åŠ¨æ€å»¶è¿Ÿ
      if: github.event_name == 'schedule' && inputs.mode != 'manual'
      run: |
        # å‘¨ä¸€ä»»åŠ¡ä¸å»¶è¿Ÿ
        if [ $(date +%u) -eq 1 ] && [ $(date +%H) -eq 8 ]; then
          echo "â© å‘¨ä¸€ä»»åŠ¡è·³è¿‡å»¶è¿Ÿ"
          exit 0
        fi
        
        DELAY=$((RANDOM % 21))
        echo "ğŸ•’ éšæœºå»¶è¿Ÿ $DELAY åˆ†é’Ÿ"
        sleep ${DELAY}m

    - name: ğŸ² å‘¨éšæœºæœºåˆ¶
      if: github.event_name == 'schedule' && inputs.mode == 'auto'
      run: |
        # ä»…å‘¨ä¸€8ç‚¹è§¦å‘éšæœºæ£€æŸ¥
        if [ $(date +%u) -eq 1 ] && [ $(date +%H) -eq 8 ]; then
          if [ $((RANDOM % 7)) -eq 0 ]; then
            echo "â© æœ¬å‘¨ä»»åŠ¡å·²è·³è¿‡"
            exit 0
          fi
        fi

    ##############################
    ### æ ¸å¿ƒä¸šåŠ¡é€»è¾‘
    ##############################
    - name: ğŸ”¢ æ™ºèƒ½ç”Ÿæˆæ—¶é•¿
      id: time_generator
      run: |
        # æ‰‹åŠ¨æ¨¡å¼
        if [[ "${{ inputs.mode }}" == "manual" ]]; then
          NUM=$((90 + RANDOM % 91))
          echo "ğŸ› ï¸ æ‰‹åŠ¨æ¨¡å¼ç”Ÿæˆ: ${NUM}s"
        
        # è‡ªåŠ¨æ¨¡å¼
        else
          CURRENT_HOUR=$(date +%H)
          case $CURRENT_HOUR in
            05)    # æ™¨é—´ä»»åŠ¡
              NUM=$((90 + RANDOM % 61)) ;;
            
            11)    # åˆé—´ä»»åŠ¡
              NUM=$((120 + RANDOM % 61)) ;;
            
            22)    # æ™šé—´ä»»åŠ¡
              NUM=$((120 + RANDOM % 61)) ;;
            
            17)    # å‘¨æœ«ä»»åŠ¡
              if [ $(date +%u) -ge 6 ]; then
                NUM=$((120 + RANDOM % 61))
              else
                echo "âš ï¸ éå‘¨æœ«è·³è¿‡å‘¨æœ«ä»»åŠ¡"
                NUM=0
              fi ;;
            
            08)    # å‘¨ä¸€ä»»åŠ¡
              NUM=$((120 + RANDOM % 61)) ;;
            
            *)
              echo "âŒ æ—¶é—´åŒ¹é…å¼‚å¸¸"
              exit 1 ;;
          esac
        fi
        
        echo "::set-output name=read_time::$NUM"
