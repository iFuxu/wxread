name: wxread

on:
  schedule:
    - cron: '0 7 * * *'         # æ—©ä¸Š7ç‚¹
    - cron: '30 12 * * *'       # ä¸­åˆ12ç‚¹åŠ
    - cron: '0 20 * * *'        # æ™šä¸Š8ç‚¹
    - cron: '0 10 * * sat'      # å‘¨å…­10ç‚¹éšæœºé˜…è¯»
    - cron: '0 10 * * sun'      # å‘¨æ—¥10ç‚¹éšæœºé˜…è¯»
  workflow_dispatch:
    inputs:
      mode:
        description: 'è¿è¡Œæ¨¡å¼ (auto/manual)'
        required: false
        default: 'auto'

jobs:
  deploy:
    runs-on: ubuntu-22.04
    environment: AutoRead

    steps:
    - name: ðŸ”§ è®¾ç½®DNS
      run: |
        echo "nameserver 8.8.8.8" | sudo tee /etc/resolv.conf
        echo "nameserver 8.8.4.4" | sudo tee -a /etc/resolv.conf
        echo "âœ… DNSé…ç½®å®Œæˆ"

    - name: ðŸ“¥ æ£€å‡ºä»“åº“
      uses: actions/checkout@v4

    - name: ðŸ è®¾ç½®Python 3.10
      uses: actions/setup-python@v5
      with:
        python-version: '3.10'

    - name: ðŸ“¦ å®‰è£…ä¾èµ–
      run: |
        python -m pip install --upgrade pip
        pip install certifi==2024.8.30 charset-normalizer==3.4.0 idna==3.10 requests==2.32.3 urllib3==2.2.3
        echo "âœ… ä¾èµ–å®‰è£…éªŒè¯ï¼š$(pip list | grep requests)"

    - name: â±ï¸ éšæœºå»¶è¿Ÿ
      if: github.event_name == 'schedule'
      run: |
        DELAY=$((RANDOM % 21))
        echo "ç”Ÿæˆçš„éšæœºå»¶è¿Ÿï¼š${DELAY}åˆ†é’Ÿ"
        sleep $((DELAY * 60))
        echo "å»¶è¿Ÿæ‰§è¡Œå®Œæˆ"

    # å…¶ä»–éƒ¨åˆ†ä¿æŒä¸å˜...

    - name: ðŸ”¢ ç”ŸæˆREAD_NUM
      run: |
        # è°ƒè¯•ä¿¡æ¯
        echo "=== è§¦å‘äº‹ä»¶åˆ†æž ==="
        echo "äº‹ä»¶ç±»åž‹: ${{ github.event_name }}"
        echo "è¾“å…¥æ¨¡å¼: ${{ github.event.inputs.mode }}"
        echo "å®šæ—¶è§„åˆ™: ${{ github.event.schedule }}"

        if [[ "${{ github.event.inputs.mode }}" == "manual" ]]; then
          # æ‰‹åŠ¨æ¨¡å¼
          NUM=$((RANDOM % 121 + 120))
          echo "ðŸ•¹ï¸ æ‰‹åŠ¨æ¨¡å¼ | èŒƒå›´: 120-240 (60-120åˆ†é’Ÿ)"
        else
          # èŽ·å–è§¦å‘è§„åˆ™
          SCHEDULE="${{ github.event.schedule }}"

          case "$SCHEDULE" in
            '0 7 * * *')
              NUM=$((RANDOM % 21 + 60))   # 60-80åˆ†é’Ÿ
              echo "ðŸŒ… æ—©é—´ä»»åŠ¡ | èŒƒå›´: 60-80" ;;
            '30 12 * * *')
              NUM=$((RANDOM % 21 + 40))  # 40-60åˆ†é’Ÿ
              echo "ðŸŒž åˆé—´ä»»åŠ¡ | èŒƒå›´: 40-60" ;;
            '0 20 * * *')
              NUM=$((RANDOM % 21 + 100))  # 100-120åˆ†é’Ÿ
              echo "ðŸŒ™ æ™šé—´ä»»åŠ¡ | èŒƒå›´: 100-120" ;;
            '0 10 * * sat')
              NUM=$((RANDOM % 121 + 120))
              echo "ðŸŽ‰ å‘¨å…­ä»»åŠ¡ | èŒƒå›´: 120-240" ;;
            '0 10 * * sun')
              NUM=$((RANDOM % 121 + 120))
              echo "ðŸŽ‰ å‘¨æ—¥ä»»åŠ¡ | èŒƒå›´: 120-240" ;;
            *)
              # å®‰å…¨æ¨¡å¼ï¼šç”Ÿæˆé»˜è®¤å€¼
              NUM=$((RANDOM % 61 + 120))
              echo "âš ï¸ æœªçŸ¥è§¦å‘ç±»åž‹ | å¯ç”¨å®‰å…¨é»˜è®¤å€¼: 120-180" ;;
          esac
        fi

        # è¾“å‡ºç»“æžœ
        echo "âœ… æœ€ç»ˆREAD_NUM: $NUM (ç­‰æ•ˆ $((NUM / 2)) åˆ†é’Ÿ)"
        echo "READ_NUM=$NUM" >> $GITHUB_ENV
