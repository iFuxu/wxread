name: WeRead Automation

on:
  schedule:
    - cron: '0 22 * * *'    # åŒ—äº¬æ—¶é—´22:00
    - cron: '0 5 * * *'     # åŒ—äº¬æ—¶é—´5:00
    - cron: '40 11 * * *'   # åŒ—äº¬æ—¶é—´11:40
    - cron: '0 17 * * 6,7'  # å‘¨æœ«17:00ï¼ˆå‘¨å…­/æ—¥ï¼‰
    - cron: '0 8 * * 1'     # å‘¨ä¸€8:00
    timezone: Asia/Shanghai  # âœ… æ­£ç¡®ä½ç½®ï¼šåœ¨scheduleåˆ—è¡¨å†…

  workflow_dispatch:
    inputs:
      mode:
        description: 'è¿è¡Œæ¨¡å¼'
        required: false
        default: 'auto'
        type: choice
        options:
          - auto
          - manual

jobs:
  generate-time:
    runs-on: ubuntu-22.04
    environment: Production

    steps:
    - name: ğŸ› ï¸ æ£€å‡ºä»“åº“
      uses: actions/checkout@v4

    - name: ğŸ è®¾ç½®Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.10'

    - name: ğŸ“¦ å®‰è£…ä¾èµ–
      run: pip install requests==2.32.3

    - name: â³ åŠ¨æ€å»¶è¿Ÿ
      if: ${{ github.event_name == 'schedule' && inputs.mode != 'manual' }}
      run: |
        if [ $(date +%u) -eq 1 ] && [ $(date +%H) -eq 8 ]; then
          echo "â© è·³è¿‡å‘¨ä¸€å»¶è¿Ÿ"
          exit 0
        fi
        DELAY=$((RANDOM % 21))
        echo "ğŸ•’ å»¶è¿Ÿ ${DELAY} åˆ†é’Ÿ"
        sleep ${DELAY}m

    - name: ğŸ¯ ç”Ÿæˆé˜…è¯»æ—¶é•¿
      id: time-gen
      run: |
        if [[ "${{ inputs.mode }}" == "manual" ]]; then
          NUM=$((90 + RANDOM % 91))
        else
          case $(date +%H) in
            05|22) NUM=$((120 + RANDOM % 61)) ;;
            11)    NUM=$((120 + RANDOM % 61)) ;;
            17)    [ $(date +%u) -ge 6 ] && NUM=$((120 + RANDOM % 61)) || NUM=0 ;;
            08)    NUM=$((120 + RANDOM % 61)) ;;
            *)     echo "âŒ æ—¶é—´åŒ¹é…é”™è¯¯"; exit 1 ;;
          esac
        fi
        echo "read_time=$NUM" >> $GITHUB_OUTPUT

    - name: ğŸ“¤ è¾“å‡ºç»“æœ
      if: ${{ steps.time-gen.outputs.read_time != 0 }}
      run: echo "âœ… ç”ŸæˆæˆåŠŸï¼š${{ steps.time-gen.outputs.read_time }}ç§’"
