name: WeRead Auto
on:
  schedule:
    - cron: '0 21 * * *'   # åŒ—äº¬æ—¶é—´5:00
    - cron: '40 3 * * *'    # åŒ—äº¬æ—¶é—´11:40 
    - cron: '0 14 * * *'    # åŒ—äº¬æ—¶é—´22:00
  workflow_dispatch:
    inputs:
      mode:
        description: 'è¿è¡Œæ¨¡å¼ (auto/manual)'
        required: false
        default: 'auto'

jobs:
  execute:
    runs-on: ubuntu-22.04
    environment: AutoRead
    env:
      B_VALUES: ${{ vars.B_VALUES }}       # ä¹¦ç±IDåˆ—è¡¨
      PUSH_METHOD: ${{ vars.PUSH_METHOD }} # æ¨é€æ–¹å¼
      WXREAD_CURL_BASH: ${{ secrets.WXREAD_CURL_BASH }}

    steps:
    # ----------------- åˆå§‹åŒ–é˜¶æ®µ -----------------
    - name: ğŸ”§ DNSé…ç½®
      run: |
        echo "nameserver 8.8.8.8" | sudo tee /etc/resolv.conf
        echo "nameserver 8.8.4.4" | sudo tee -a /etc/resolv.conf

    - name: ğŸ“¥ ä»£ç æ£€å‡º
      uses: actions/checkout@v4
      with:
        path: main-repo

    # ---------------- ç¯å¢ƒå‡†å¤‡ --------------------
    - name: ğŸ Pythonç¯å¢ƒ
      uses: actions/setup-python@v5
      with:
        python-version: '3.10'
        cache: 'pip'

    - name: ğŸ“¦ å®‰è£…ä¾èµ–
      working-directory: main-repo
      run: |
        pip install requests==2.32.3 python-dotenv==1.0.0
        echo "âœ… ä¾èµ–å®‰è£…å®Œæˆ"

    # ---------------- æ‰§è¡Œæ§åˆ¶ --------------------
    - name: â³ éšæœºå»¶è¿Ÿ
      run: |
        DELAY=$(($RANDOM % 21))
        echo "ğŸ•’ å»¶è¿Ÿ ${DELAY} åˆ†é’Ÿå¯åŠ¨"
        sleep $(($DELAY * 60))

    - name: ğŸ² ç”ŸæˆåŠ¨æ€å‚æ•°
      id: params
      working-directory: main-repo
      run: |
        HOUR=$(date -u +%H)
        case $HOUR in
          21)   # å¯¹åº”åŒ—äº¬æ—¶é—´5:00
            READ_NUM=$((90 + $RANDOM % 41)) ;;  # 90-130æ¬¡
          3)    # å¯¹åº”åŒ—äº¬æ—¶é—´11:40
            READ_NUM=$((120 + $RANDOM % 61)) ;; # 120-180æ¬¡
          14)   # å¯¹åº”åŒ—äº¬æ—¶é—´22:00
            READ_NUM=$((180 + $RANDOM % 61)) ;; # 180-240æ¬¡
          *)
            READ_NUM=150 ;;
        esac
        echo "READ_NUM=$READ_NUM" >> $GITHUB_ENV
        echo "ç”Ÿæˆé˜…è¯»æ¬¡æ•°: $READ_NUM"

    - name: ğŸš€ æ‰§è¡Œä»»åŠ¡
      working-directory: main-repo
      env:
        READ_NUM: ${{ env.READ_NUM }}
        PUSHPLUS_TOKEN: ${{ secrets.PUSHPLUS_TOKEN }}
      run: |
        python main.py
